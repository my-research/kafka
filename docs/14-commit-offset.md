# commit & offset

- 카프카는 컨슈머 그룹이 메시지를 어디까지 가져갔는지 offset 을 통해서 알 수 있음
  - 컨슈머들이 각각의 파티션에 본인이 가져간 메시지의 위치정보(offset) 을 업데이트 (commit) 함
- 커밋과 오프센 정보를 카프카가 관리함
  - 카프카 내부에서 (__consumer_offsets) 이라는 토픽을 만들고 그 오프셋 정보를 저장함
  - 0.9 버전 이하 카프카에서는 주키퍼에 해당 정보를 저장함

# 리밸런싱과 commit

- 컨슈머 문제로 리밸런싱이 일어나 컨슈머가 새로운 파티션에 할당되면 해당 파티션에 대해 최근 커밋 정보로 오프셋을 확인 후 메시지를 가져옴
  - 이 과정에서 메시지 중복이나 누락이 발생할 수 있음
  - 중복: 커밋된 오프셋 < 실제 처리한 오프셋
  - 누락: 커밋된 오프셋 > 실제 처리한 오프셋
- commit 은 at least once 를 지향함

# auto commit

- 메시지를 가져올 때마다 커밋하는 방법
- 오프셋 관리하기 가장 쉬운 방법
- `poll()` 을 호출할 때 가장 마지막 오프셋을 커밋함
- 기본으로 5초 주기
- auto commit 중 re-balance 가 발생하면 중복 메시지가 나올 수 있음

# manual commit

- 메시지 처리가 완료될 때까지 메시지를 가져온 것으로 간주하지 않는 경우에 사용됨
  - 즉, db 에 저장되고 나서 commit 하는 방법
